<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="crm_team_view_form_inherit_budget" model="ir.ui.view">
        <field name="name">crm.team.form.inherit.budget</field>
        <field name="model">crm.team</field>
        <field name="inherit_id" ref="sales_team.crm_team_view_form"/>
        <field name="arch" type="xml">

            <xpath expr="//div[hasclass('oe_button_box')]" position="inside">
                <button name="action_view_forecasts"
                        type="object"
                        class="oe_stat_button"
                        icon="fa-line-chart"
                        invisible="forecast_count == 0">
                    <field name="forecast_count" widget="statinfo" string="–ü—Ä–æ–≥–Ω–æ–∑–∏"/>
                </button>
                <button name="action_create_forecast"
                        type="object"
                        class="oe_stat_button"
                        icon="fa-plus"> <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">–°—Ç–≤–æ—Ä–∏—Ç–∏</span>
                        <span class="o_stat_text">–ø—Ä–æ–≥–Ω–æ–∑</span>
                    </div>
                </button>
            </xpath>

            <xpath expr="//field[@name='user_id']" position="after">
                <field name="responsibility_center_id" options="{'no_create': True}"/>
                <field name="default_forecast_channel"/>
                <field name="default_customer_segment"/>
            </xpath>

            <xpath expr="//notebook" position="inside">
                <page string="–ë—é–¥–∂–µ—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ –ø—Ä–æ–≥–Ω–æ–∑–∏" groups="budget.group_budget_user">
                    <group>
                        <group string="–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±—é–¥–∂–µ—Ç—É–≤–∞–Ω–Ω—è">
                            <field name="budget_responsible_user_id"/>
                            <field name="auto_create_forecasts"/>
                        </group>
                        <group string="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞">
                            <field name="forecast_count" readonly="1"/>
                            <field name="active_forecasts_count" readonly="1"/>
                        </group>
                    </group>

                    <separator string="–û—Å—Ç–∞–Ω–Ω—ñ –ø—Ä–æ–≥–Ω–æ–∑–∏"/>
                    <field name="forecast_ids" nolabel="1" readonly="1">
                        <tree limit="5" create="false" edit="false" delete="false">
                            <field name="name"/>
                            <field name="period_id"/>
                            <field name="channel"/>
                            <field name="total_forecast_amount" widget="monetary"/>
                            <field name="state"/>
                            <field name="user_id"/>
                        </tree>
                    </field>

                    <div class="oe_clear">
                        <button name="action_view_forecasts"
                                string="–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –≤—Å—ñ –ø—Ä–æ–≥–Ω–æ–∑–∏"
                                type="object"
                                class="btn-primary"
                                icon="fa-eye"
                                invisible="forecast_count == 0"/>
                        <button name="action_create_forecast"
                                string="–°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π –ø—Ä–æ–≥–Ω–æ–∑"
                                type="object"
                                class="btn-success"
                                icon="fa-plus"/>
                    </div>
                </page>
            </xpath>

        </field>
    </record>

    <record id="crm_team_view_tree_inherit_budget" model="ir.ui.view">
        <field name="name">crm.team.tree.inherit.budget</field>
        <field name="model">crm.team</field>
        <field name="inherit_id" ref="sales_team.crm_team_view_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='user_id']" position="after">
                <field name="responsibility_center_id"/>
                <field name="forecast_count"/>
                <field name="default_forecast_channel"/>
            </xpath>
        </field>
    </record>

    <record id="crm_team_view_search_inherit_budget" model="ir.ui.view">
        <field name="name">crm.team.search.inherit.budget</field>
        <field name="model">crm.team</field>
        <field name="inherit_id" ref="sales_team.crm_team_view_search"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='name']" position="after">
                <field name="responsibility_center_id"/>
                <field name="default_forecast_channel"/>
            </xpath>

            <xpath expr="/search" position="inside">
                <separator/>
                <filter string="–ó –¶–ë–û"
                        name="with_cbo"
                        domain="[('responsibility_center_id', '!=', False)]"/>
                <filter string="–ó –ø—Ä–æ–≥–Ω–æ–∑–∞–º–∏"
                        name="with_forecasts"
                        domain="[('forecast_count', '>', 0)]"/>
                <filter string="–ú–æ—ó –∫–æ–º–∞–Ω–¥–∏"
                        name="my_teams"
                        domain="['|', ('user_id', '=', uid), ('member_ids', 'in', [uid])]"/>
                </xpath>

            <xpath expr="//group" position="inside">
                <filter string="–ó–∞ –¶–ë–û"
                        name="group_cbo"
                        context="{'group_by': 'responsibility_center_id'}"/>
                <filter string="–ó–∞ –∫–∞–Ω–∞–ª–æ–º"
                        name="group_channel"
                        context="{'group_by': 'default_forecast_channel'}"/>
            </xpath>
        </field>
    </record>

    <record id="action_create_forecast_from_team" model="ir.actions.server">
        <field name="name">–°—Ç–≤–æ—Ä–∏—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è –∫–æ–º–∞–Ω–¥–∏</field>
        <field name="model_id" ref="sales_team.model_crm_team"/>
        <field name="binding_model_id" ref="sales_team.model_crm_team"/>
        <field name="binding_view_types">list,form</field>
        <field name="state">code</field>
        <field name="code">
# –í–∏–ø—Ä–∞–≤–ª–µ–Ω–∏–π –∫–æ–¥ –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—Ä–æ–≥–Ω–æ–∑—É
for team in records:
    # –ó–Ω–∞—Ö–æ–¥–∏–º–æ –ø–æ—Ç–æ—á–Ω–∏–π –ø–µ—Ä—ñ–æ–¥ –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è
    current_period = env['budget.period'].search([
        ('date_start', '&lt;=', fields.Date.today()),
        ('date_end', '&gt;=', fields.Date.today()),
        ('state', 'in', ['draft', 'planning'])
    ], limit=1)

    if not current_period:
        # –Ø–∫—â–æ –Ω–µ–º–∞—î –ø–æ—Ç–æ—á–Ω–æ–≥–æ, –±–µ—Ä–µ–º–æ –Ω–∞–π–±–ª–∏–∂—á–∏–π –º–∞–π–±—É—Ç–Ω—ñ–π
        current_period = env['budget.period'].search([
            ('date_start', '&gt;', fields.Date.today()),
            ('state', 'in', ['draft', 'planning'])
        ], order='date_start asc', limit=1)

    if not current_period:
        raise UserError('–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–µ—Ä—ñ–æ–¥—É –¥–ª—è –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è. –°—Ç–≤–æ—Ä—ñ—Ç—å –ø–µ—Ä—ñ–æ–¥ –≤ –º–µ–Ω—é –ë—é–¥–∂–µ—Ç—É–≤–∞–Ω–Ω—è > –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è > –ü–µ—Ä—ñ–æ–¥–∏')

    # –°—Ç–≤–æ—Ä—é—î–º–æ –ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è –∫–æ–º–∞–Ω–¥–∏
    forecast_vals = {
        'period_id': current_period.id,
        'team_id': team.id,
        'user_id': env.user.id,
        'channel': team.default_forecast_channel or 'direct',
        'customer_segment': team.default_customer_segment or 'existing',
        'forecast_base': 'manual',
        'state': 'draft',
    }

    # –î–æ–¥–∞—î–º–æ –¶–ë–û, —è–∫—â–æ —î
    if team.responsibility_center_id:
        forecast_vals['cbo_id'] = team.responsibility_center_id.id

    # –î–æ–¥–∞—î–º–æ –∫–æ–º–ø–∞–Ω—ñ—é
    if team.company_id:
        forecast_vals['company_id'] = team.company_id.id
    else:
        forecast_vals['company_id'] = env.company.id

    forecast = env['sale.forecast'].create(forecast_vals)

    action = {
        'type': 'ir.actions.act_window',
        'name': f'–ü—Ä–æ–≥–Ω–æ–∑ –¥–ª—è –∫–æ–º–∞–Ω–¥–∏ {team.name}',
        'res_model': 'sale.forecast',
        'res_id': forecast.id,
        'view_mode': 'form',
        'target': 'current',
    }
        </field>
    </record>

    <record id="action_crm_teams_with_budget" model="ir.actions.act_window">
        <field name="name">–ö–æ–º–∞–Ω–¥–∏ –ø—Ä–æ–¥–∞–∂—ñ–≤</field>
        <field name="res_model">crm.team</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="context">{
            'search_default_with_cbo': 1
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                –ù–∞–ª–∞—à—Ç—É–π—Ç–µ –∫–æ–º–∞–Ω–¥–∏ –ø—Ä–æ–¥–∞–∂—ñ–≤ –¥–ª—è –±—é–¥–∂–µ—Ç—É–≤–∞–Ω–Ω—è!
            </p>
            <p>
                –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∫–æ–º–∞–Ω–¥ –ø—Ä–æ–¥–∞–∂—ñ–≤ –∑ –±—é–¥–∂–µ—Ç—É–≤–∞–Ω–Ω—è–º –¥–æ–∑–≤–æ–ª—è—î:
                <ul>
                    <li>–ü—Ä–∏–≤'—è–∑—É–≤–∞—Ç–∏ –∫–æ–º–∞–Ω–¥–∏ –¥–æ –¶–ë–û</li>
                    <li>–°—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑–∏ –ø—Ä–æ–¥–∞–∂—ñ–≤</li>
                    <li>–ê–≤—Ç–æ–º–∞—Ç–∏–∑—É–≤–∞—Ç–∏ –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è –¥–æ—Ö–æ–¥—ñ–≤</li>
                    <li>–ö–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø–ª–∞–Ω—ñ–≤</li>
                </ul>
            </p>
        </field>
    </record>

    <record id="action_crm_teams_dashboard" model="ir.actions.act_window">
        <field name="name">–î–∞—à–±–æ—Ä–¥ –∫–æ–º–∞–Ω–¥ –ø—Ä–æ–¥–∞–∂—ñ–≤</field>
        <field name="res_model">crm.team</field>
        <field name="view_mode">kanban</field>
        <field name="domain">[('forecast_count', '>', 0)]</field>
        <field name="context">{
            'search_default_active': 1,
            'kanban_default_group_by': 'responsibility_center_id'
        }</field>
    </record>

    <menuitem id="menu_budget_teams_dashboard"
              name="üìà –î–∞—à–±–æ—Ä–¥ –∫–æ–º–∞–Ω–¥"
              parent="menu_budget_reports"
              action="action_crm_teams_dashboard"
              sequence="25"/>

</odoo>