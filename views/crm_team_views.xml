<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- views/crm_team_views.xml -->

    <!-- Расширение формы команды продаж -->
    <record id="crm_team_view_form_inherit_budget" model="ir.ui.view">
        <field name="name">crm.team.form.inherit.budget</field>
        <field name="model">crm.team</field>
        <field name="inherit_id" ref="sales_team.crm_team_view_form"/>
        <field name="arch" type="xml">

            <!-- Добавляем кнопки в header -->
            <xpath expr="//header" position="inside">
                <button name="action_view_forecasts"
                        type="object"
                        class="oe_stat_button"
                        icon="fa-line-chart"
                        invisible="forecast_count == 0">
                    <field name="forecast_count" widget="statinfo" string="Прогнози"/>
                </button>
                <button name="action_create_forecast"
                        type="object"
                        class="oe_stat_button"
                        icon="fa-plus"
                        string="Створити прогноз"/>
            </xpath>

            <!-- Добавляем поля в основную группу -->
            <xpath expr="//sheet//group[1]" position="after">
                <group string="Інтеграція з бюджетуванням">
                    <group>
                        <field name="responsibility_center_id" options="{'no_create': True}"/>
                        <field name="forecast_count" readonly="1"/>
                        <field name="active_forecasts_count" readonly="1"/>
                    </group>
                    <group>
                        <field name="default_forecast_channel"/>
                        <field name="default_customer_segment"/>
                    </group>
                </group>
            </xpath>

        </field>
    </record>

    <!-- Расширение tree view команды продаж -->
    <record id="crm_team_view_tree_inherit_budget" model="ir.ui.view">
        <field name="name">crm.team.tree.inherit.budget</field>
        <field name="model">crm.team</field>
        <field name="inherit_id" ref="sales_team.crm_team_view_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='name']" position="after">
                <field name="responsibility_center_id"/>
                <field name="forecast_count"/>
                <field name="default_forecast_channel"/>
            </xpath>
        </field>
    </record>

    <!-- Server action для создания прогноза из команды -->
    <record id="action_create_forecast_from_team" model="ir.actions.server">
        <field name="name">Створити прогноз</field>
        <field name="model_id" ref="sales_team.model_crm_team"/>
        <field name="binding_model_id" ref="sales_team.model_crm_team"/>
        <field name="binding_view_types">list,form</field>
        <field name="state">code</field>
        <field name="code">
for team in records:
    action = {
        'type': 'ir.actions.act_window',
        'name': f'Створити прогноз для {team.name}',
        'res_model': 'sales.plan.wizard',
        'view_mode': 'form',
        'target': 'new',
        'context': {
            'default_team_id': team.id,
            'default_forecast_scope': 'team',
            'default_channel': team.default_forecast_channel or 'direct',
            'default_customer_segment': team.default_customer_segment or 'existing',
            'default_cbo_id': team.responsibility_center_id.id if team.responsibility_center_id else False,
        }
    }
        </field>
    </record>

</odoo>