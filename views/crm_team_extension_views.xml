<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- views/crm_team_extension_views.xml -->

    <!-- Расширение формы команды продаж -->
    <record id="view_crm_team_form_budget_extension" model="ir.ui.view">
        <field name="name">crm.team.form.budget.extension</field>
        <field name="model">crm.team</field>
        <field name="inherit_id" ref="sales_team.crm_team_view_form"/>
        <field name="arch" type="xml">
            <xpath expr="//notebook" position="inside">
                <page string="Бюджетування та прогнози">
                    <group>
                        <group string="Налаштування бюджетування">
                            <field name="budget_responsible_user_id"/>
                            <field name="auto_create_forecasts"/>
                            <field name="forecast_count"/>
                        </group>
                    </group>

                    <group string="Прогнози продаж">
                        <button name="action_view_forecasts"
                                string="Переглянути прогнози"
                                type="object"
                                class="btn-primary"
                                invisible="forecast_count == 0"/>
                        <field name="forecast_ids" nolabel="1">
                            <tree limit="5">
                                <field name="period_id"/>
                                <field name="channel"/>
                                <field name="total_forecast_amount"/>
                                <field name="state"/>
                                <field name="user_id"/>
                            </tree>
                        </field>
                    </group>
                </page>
            </xpath>
        </field>
    </record>

    <!-- Дополнительные действия в команде продаж -->
    <record id="action_create_forecast_for_team" model="ir.actions.server">
        <field name="name">Створити прогноз для команди</field>
        <field name="model_id" ref="crm.model_crm_team"/>
        <field name="binding_model_id" ref="crm.model_crm_team"/>
        <field name="binding_view_types">form</field>
        <field name="state">code</field>
        <field name="code">
if record:
    # Находим текущий период планирования
    current_period = env['budget.period'].search([
        ('date_start', '&lt;=', fields.Date.today()),
        ('date_end', '&gt;=', fields.Date.today()),
        ('state', 'in', ['draft', 'planning'])
    ], limit=1)

    if not current_period:
        raise UserError('Не знайдено активного періоду для планування')

    # Создаем прогноз для команды
    forecast = env['sale.forecast'].create({
        'period_id': current_period.id,
        'team_id': record.id,
        'user_id': env.user.id,
        'channel': 'direct',  # По умолчанию
        'forecast_base': 'manual',
    })

    action = {
        'type': 'ir.actions.act_window',
        'name': 'Новый прогноз',
        'res_model': 'sale.forecast',
        'res_id': forecast.id,
        'view_mode': 'form',
        'target': 'current',
    }
        </field>
    </record>

</odoo>